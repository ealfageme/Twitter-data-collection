{% load staticfiles %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Twitter</title>

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link href="https://fonts.googleapis.com/css?family=Lobster&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="{% static 'css/search.css' %}">

</head>

    <body>
        <canvas id="network" width="1400" height="700"></canvas>
    </body>
        <script src="{% static 'lib/neo4j-web.min.js' %}"></script>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script>
        /* global d3 */

         var graph ={
            nodes:[],
            links:[]
         };
        function connect(){
            const host = 'bolt://localhost';
            const driver = neo4j.v1.driver(host, neo4j.v1.auth.basic("neo4j", "password"));
            const session = driver.session();
            const all_nodes = 'Match(n:Account) return n.username';
            const all_relationship = 'MATCH (a:Account)-[r:`Follow to`]->(b:Account) RETURN a.username,b.username'
            const width = 1400; //document.getElementById('canvas').clientWidth;
            const height = 700; //document.getElementById('canvas').clientHeight;
            session.run(all_nodes).then((result) => {
              // Close the neo4j session
              session.close();
              for(var i in result.records) {
                  var node = {};
                  node.username = result.records[i]._fields
                  node.x = Math.random()*width;
                  node.y = Math.random()*height;
                graph.nodes.push(node);
              }
            }).catch( (error) => {
              console.error(error);
            });

            session.run(all_relationship).then((result) => {
              // Close the neo4j session
              session.close();
               for(var i in result.records) {
                  var link = {};
                  link.source = result.records[i]._fields[0];
                  link.target = result.records[i]._fields[1];
                graph.links.push(link);
                //    console.log(result.records[i]._fields);

              }
              // console.log('Response from Neo4j:', JSON.stringify(result, null, 2));
            }).catch( (error) => {
              console.error(error);
            });
            return true;
        }

        function filling(){

            var canvas = d3.select("#network"),
                width = canvas.attr("width"),
                height = canvas.attr("height"),
//                width = 800, // document.getElementById('network').clientWidth,
//                height = 450, //document.getElementById('network').clientHeight,
                ctx = canvas.node().getContext("2d"),
                r = 15,
                color = d3.scaleOrdinal(d3.schemeCategory20),
                simulation = d3.forceSimulation()
                    .force("x", d3.forceX(width/2))
                    .force("y", d3.forceY(height/2))
                    .force("collide", d3.forceCollide(r+1))
                    .force("charge", d3.forceManyBody()
                        .strength(-800))
                    .on("tick",update)
                    .force("link", d3.forceLink()
                        .id(function (d) { return d.username;}));

            simulation.nodes(graph.nodes);
            simulation.force("link")
                .links(graph.links);

            function update() {
                ctx.clearRect(0,0,width,height);

                ctx.beginPath();
            //    ctx.globalAlpha = 0.5;
                ctx.strokeStyle = "#766b70";
                graph.links.forEach(drawLink);
                ctx.stroke();


                ctx.globalAlpha = 1.0;
                graph.nodes.forEach(drawNode);


            }
            canvas
                .call(d3.drag()
                    .container(canvas.node())
                    .subject(dragsubject)
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

             function dragsubject() {
                  return simulation.find(d3.event.x,d3.event.y);
             }
            function dragstarted() {
              if (!d3.event.active) simulation.alphaTarget(0.3).restart();
              d3.event.subject.fx = d3.event.subject.x;
              d3.event.subject.fy = d3.event.subject.y;
              console.log(d3.event.subject);
            }

            function dragged() {
              d3.event.subject.fx = d3.event.x;
              d3.event.subject.fy = d3.event.y;
            }

            function dragended() {
              if (!d3.event.active) simulation.alphaTarget(0);
              d3.event.subject.fx = null;
              d3.event.subject.fy = null;
            }

            function drawNode(d) {
              ctx.beginPath();
              ctx.fillStyle = '#FCA205';
              ctx.moveTo(d.x,d.y);
              ctx.arc(d.x,d.y,r,0,Math.PI*2);
              ctx.fill();
            }
            function drawLink(l) {
              ctx.moveTo(l.source.x,l.source.y);
              ctx.lineTo(l.target.x,l.target.y);
            }
        }
        connect()
        </script>

    </body>
</html>
</html>